<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Evacuation Info</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .legend {
      max-width: 900px;
      width: 100%;
      padding: 12px 8px 4px 8px;
      font-size: 12px;
      text-align: center;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .legend-items {
      display: inline-flex;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    /* Road closure icon */
    .legend-icon-road {
      position: relative;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #d60000;
      display: inline-block;
    }
    .legend-icon-road::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 4px;
      background: black;
      transform: translateY(-50%);
    }

    /* Info icon */
    .legend-icon-info {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #0078d4;
      color: white;
      font-weight: bold;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Warning icon (diamond) */
    .legend-icon-warning {
      width: 16px;
      height: 16px;
      background: #f6e05e;
      transform: rotate(45deg);
      border: 1px solid #c7b100;
      box-sizing: border-box;
      display: inline-block;
    }

    .evac-row {
      display: flex;
      gap: 12px;
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    @media (max-width: 600px) {
      .evac-row {
        flex-direction: column;
        padding: 6px;
        gap: 8px;
      }
    }

    .evac-box {
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      box-sizing: border-box;
      flex: 1;
      min-width: 260px;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 600px) {
      .evac-box {
        padding: 10px;
        min-width: 0;
      }
    }

    .evac-title {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 8px;
    }

    @media (max-width: 600px) {
      .evac-title {
        font-size: 16px;
        margin-bottom: 6px;
      }
    }

    .evac-body {
      font-size: 14px;
      line-height: 1.4;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 600px) {
      .evac-body {
        font-size: 13px;
      }
    }

    .evac-zones {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .evac-zones {
        gap: 4px;
        margin-top: 6px;
      }
    }

    .zone-chip,
    .no-zones-chip {
      font-weight: bold;
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      border-radius: 6px;
      white-space: normal;
      max-width: 100%;
    }

    @media (max-width: 600px) {
      .zone-chip,
      .no-zones-chip {
        padding: 3px 6px;
        font-size: 12px;
      }
    }

    .evac-note {
      margin-top: 12px;
      font-size: 14px;
      font-style: italic;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .evac-note {
        margin-top: 8px;
        font-size: 13px;
      }
    }

    /* NEW: container for the incident status / evac info panel from Sheets */
    .incident-panel {
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
      padding: 0 8px 12px 8px;
    }
  </style>
</head>
<body>

<div class="legend">
  <div class="legend-title">Map Key</div>
  <div class="legend-items">
    <div class="legend-item">
      <span class="legend-icon-road"></span>
      <span>Road closure</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon-info">i</span>
      <span>Information</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon-warning"></span>
      <span>Special warning</span>
    </div>
  </div>
</div>

<!-- SET / GO ZONE BOXES -->
<div id="evacRow" class="evac-row">
  Loading evacuation information…
</div>

<!-- NEW: INCIDENT STATUS / EVAC INFO PANEL FROM GOOGLE SHEET -->
<div class="incident-panel">
  <div id="incident-panel">Loading incident status…</div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  // using var so it’s visible to the second script if needed
  var INCIDENT = params.get('incident') || 'East Canyon';

  const STATUS_LABELS = {
    SET: 'SET - Pre-Evacuation',
    GO: 'GO - Evacuate Now'
  };

  const STATUS_COLORS = {
    SET: '#fff36a',
    GO: '#41f56e'
  };

  const STATUS_TEXT = {
    SET: 'Voluntary Evacuation;<br>Evacuation orders are likely',
    GO: '<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.'
  };

  const url = 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query';
  const where = `incident='${INCIDENT}' AND STATUS IN ('Set','Go')`;

  const queryParams = new URLSearchParams({
    where,
    outFields: '*',
    f: 'json',
    returnGeometry: 'false'
  });

  fetch(url + '?' + queryParams.toString())
    .then(r => r.json())
    .then(data => {
      const row = document.getElementById('evacRow');

      if (!data.features || data.features.length === 0) {
        row.innerHTML = `
          <div class="evac-box" style="background:#fff36a;">
            <div class="evac-title">No data</div>
            <div class="evac-body">
              No zones found for <strong>${INCIDENT}</strong>.
            </div>
          </div>`;
        return;
      }

      const setFeatures = data.features.filter(
        f => f.attributes.STATUS === 'Set'
      );
      const goFeatures = data.features.filter(
        f => f.attributes.STATUS === 'Go'
      );

      function buildBox(statusCode, features) {
        const label = STATUS_LABELS[statusCode];
        const bg = STATUS_COLORS[statusCode];
        const note = STATUS_TEXT[statusCode];

        let zonesHTML;
        if (!features || features.length === 0) {
          zonesHTML = `
            <div class="evac-zones">
              <div class="no-zones-chip">No ${statusCode} zones</div>
            </div>`;
        } else {
          const chips = features
            .map(f => `<div class="zone-chip">${f.attributes.zonename}</div>`)
            .join('');
          zonesHTML = `<div class="evac-zones">${chips}</div>`;
        }

        return `
          <div class="evac-box" style="background:${bg};">
            <div class="evac-title">${label}</div>
            <div class="evac-body">
              <div>
                The following zones are under ${statusCode} status for
                <strong>${INCIDENT}</strong>.
              </div>
              ${zonesHTML}
              <div class="evac-note">${note}</div>
            </div>
          </div>`;
      }

      row.innerHTML =
        buildBox('SET', setFeatures) +
        buildBox('GO', goFeatures);
    })
    .catch(err => {
      document.getElementById('evacRow').innerHTML = `
        <div class="evac-box" style="background:#fff36a;">
          <div class="evac-title">Error</div>
          <div class="evac-body">${err}</div>
        </div>`;
    });
</script>

<!-- NEW SCRIPT: LOAD INCIDENT STATUS / EVAC INFO FROM GOOGLE SHEETS -->
<script>
  const STATUS_BASE_URL = "https://script.google.com/macros/s/AKfycbyGmLETNgj4DVhCXUkzTL1Eln-TrlPRZh1hle8isREM7TrKOzkUCga-KKBdkoz1RaTPvw/exec";

  function loadIncidentStatus(incidentName) {
    if (!incidentName) {
      document.getElementById("incident-panel").innerHTML =
        "<div>No incident specified.</div>";
      return;
    }

    const url = STATUS_BASE_URL + "?incident=" + encodeURIComponent(incidentName);

    fetch(url)
      .then(r => r.text())
      .then(html => {
        // html is exactly the card you saw earlier
        document.getElementById("incident-panel").innerHTML = html;
      })
      .catch(err => {
        console.error("Error loading incident status:", err);
        document.getElementById("incident-panel").innerHTML =
          "<div>Error loading incident status.</div>";
      });
  }

  // Use the same INCIDENT name as the zone query
  const incidentForPanel =
    (typeof INCIDENT !== "undefined" && INCIDENT) ||
    new URLSearchParams(window.location.search).get("incident") ||
    "East Canyon";

  loadIncidentStatus(incidentForPanel);

  // Optional: expose for other widgets / future use
  window.setEvacIncidentStatus = loadIncidentStatus;
</script>

</body>
</html>

