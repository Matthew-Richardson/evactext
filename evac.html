<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Evacuation Info</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: transparent;
      display: flex;
      flex-direction: column;  /* stack row + legend */
      align-items: center;
      min-height: 100vh;
    }

    /* Outer row holding both boxes */
    .evac-row {
      display: flex;
      gap: 12px;
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      flex-wrap: wrap; /* allows stacking on very small screens */
    }

    .evac-box {
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      box-sizing: border-box;
      flex: 1;               /* equal width side by side */
      min-width: 0;          /* flexbox overflow fix */
      display: flex;
      flex-direction: column;
    }

    .evac-title {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .evac-body {
      font-size: 14px;
      line-height: 1.4;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Zone chips */
    .evac-zones {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .zone-chip {
      font-weight: bold;
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      border-radius: 6px;
      white-space: normal;
      word-wrap: break-word;
      max-width: 100%;
    }

    /* "No zones" message */
    .no-zones-chip {
      font-weight: bold;
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      border-radius: 6px;
      white-space: normal;
      word-wrap: break-word;
      max-width: 100%;
    }

    .evac-note {
      margin-top: 12px;
      font-size: 14px;
      font-style: italic;
      font-weight: bold;
    }

    /* Legend / key */
    .legend {
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
      padding: 0 8px 8px 8px;
      font-size: 12px;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      box-sizing: border-box;
    }

    .legend-icon-road {
      background: #444;
      color: #fff;
    }

    .legend-icon-info {
      background: #0078d4;
      color: #fff;
    }

    .legend-icon-warning {
      background: #f6ad55;
      color: #000;
    }
  </style>
</head>
<body>

<div id="evacRow" class="evac-row">
  Loading evacuation information…
</div>

<div class="legend">
  <div class="legend-title">Map Key</div>
  <div class="legend-items">
    <div class="legend-item">
      <span class="legend-icon legend-icon-road">X</span>
      <span>Road closure</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon legend-icon-info">i</span>
      <span>Information</span>
    </div>
    <div class="legend-item">
      <span class="legend-icon legend-icon-warning">▲</span>
      <span>Special warning</span>
    </div>
  </div>
</div>

<script>
// ------------------------------------
// Read INCIDENT from URL
// ------------------------------------
const params = new URLSearchParams(window.location.search);
let INCIDENT = params.get('incident') || 'East Canyon';

// Status titles
const STATUS_LABELS = {
  SET: 'SET - Pre-Evacuation',
  GO:  'GO - Evacuate Now'
};

// Background colors
const STATUS_COLORS = {
  SET: '#fff36a',
  GO:  '#41f56e'
};

// Custom text blocks
const STATUS_TEXT = {
  SET: `
    Voluntary Evacuation;<br>
    Evacuation orders are likely
  `,
  GO: `
    <strong>LEAVE NOW.</strong> Immediate threat to life.<br>
    This area is closed to public access.
  `
};

// ------------------------------------
// Query the feature service for SET+GO
// ------------------------------------
const url =
  'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query';

const where = `incident='${INCIDENT}' AND STATUS IN ('SET','GO')`;

const queryParams = new URLSearchParams({
  where: where,
  outFields: '*',
  f: 'json',
  returnGeometry: 'false'
});

fetch(url + '?' + queryParams.toString())
  .then(r => r.json())
  .then(data => {
    const row = document.getElementById('evacRow');

    if (!data.features || data.features.length === 0) {
      row.innerHTML =
        `<div class="evac-box" style="background:#fff36a;">
           <div class="evac-title">No data</div>
           <div class="evac-body">
             No zones found for incident <strong>${INCIDENT}</strong>.
           </div>
         </div>`;
      return;
    }

    // Split SET vs GO
    const setFeatures = data.features.filter(
      f => String(f.attributes.STATUS).toUpperCase() === 'SET'
    );
    const goFeatures  = data.features.filter(
      f => String(f.attributes.STATUS).toUpperCase() === 'GO'
    );

    // Build a box (SET or GO)
    function buildBox(statusCode, features) {
      const label     = STATUS_LABELS[statusCode];
      const bg        = STATUS_COLORS[statusCode];
      const note      = STATUS_TEXT[statusCode];

      let innerZones;

      if (!features || features.length === 0) {
        innerZones =
          `<div class="evac-zones">
             <div class="no-zones-chip">No ${statusCode} zones</div>
           </div>`;
      } else {
        const zones = features.map(f => f.attributes.zonename);
        const chips = zones
          .map(z => `<div class="zone-chip">${z}</div>`)
          .join('');
        innerZones = `<div class="evac-zones">${chips}</div>`;
      }

      return `
        <div class="evac-box" style="background:${bg};">
          <div class="evac-title">${label}</div>
          <div class="evac-body">
            <div>
              The following zones are under ${statusCode} status
              for incident: <strong>${INCIDENT}</strong>.
            </div>
            ${innerZones}
            <div class="evac-note">${note}</div>
          </div>
        </div>
      `;
    }

    // Render SET (left) + GO (right)
    row.innerHTML =
      buildBox('SET', setFeatures) +
      buildBox('GO',  goFeatures);
  })
  .catch(err => {
    console.error(err);
    document.getElementById('evacRow').innerHTML =
      `<div class="evac-box" style="background:#fff36a;">
         <div class="evac-title">Error</div>
         <div class="evac-body">Error fetching data: ${err}</div>
       </div>`;
  });
</script>

</body>
</html>
